<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åŒ—ä¹å·ãƒãƒ©ã‚½ãƒ³2026 EXPO æ··é›‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Helvetica Neue',Arial,'Hiragino Sans',sans-serif;background:#0a0e1a;color:#e2e8f0;overflow-x:hidden}

.header{background:linear-gradient(135deg,#111827,#1e293b);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:3px solid #2563eb;flex-wrap:wrap;gap:8px}
.header h1{font-size:22px;font-weight:800;letter-spacing:-0.5px}
.header .sub{font-size:12px;color:#64748b;margin-top:2px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}
.badge-live{background:#ef4444;color:#fff;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}

.layout{display:grid;grid-template-columns:1fr 380px;min-height:calc(100vh - 65px)}
.left{padding:12px;display:flex;flex-direction:column;gap:8px}
.right{background:#111827;border-left:2px solid #1e293b;padding:14px;overflow-y:auto;max-height:calc(100vh - 65px)}

.map-wrap{flex:1;background:#0d1321;border-radius:14px;overflow:hidden;border:1px solid #1e293b;position:relative}
canvas{display:block;width:100%;cursor:crosshair}

.ctrl{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#111827;border-radius:10px;border:1px solid #1e293b;flex-wrap:wrap}
.ctrl .time{font-size:28px;font-weight:800;color:#60a5fa;min-width:70px;font-variant-numeric:tabular-nums}
.ctrl .slider{flex:1;min-width:100px}
.ctrl input[type=range]{width:100%;height:8px;-webkit-appearance:none;background:#1e293b;border-radius:4px;outline:none}
.ctrl input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#3b82f6;cursor:pointer;box-shadow:0 0 8px rgba(59,130,246,.5)}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;transition:all .15s}
.btn-play{background:#2563eb;color:#fff;font-size:16px}
.btn-play:hover{background:#1d4ed8}
.btn-play.on{background:#dc2626}
.spd{display:flex;gap:3px}
.spd button{background:#1e293b;color:#94a3b8;border:1px solid #334155;font-size:12px;padding:5px 10px;border-radius:6px;cursor:pointer;font-weight:600}
.spd button.on{background:#2563eb;color:#fff;border-color:#3b82f6}
.arrived{font-size:13px;color:#94a3b8;white-space:nowrap}

.card{background:#0d1321;border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid #1e293b}
.card-t{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.row{display:flex;justify-content:space-between;align-items:center;padding:5px 0}
.row-l{font-size:13px;color:#94a3b8}
.row-v{font-size:18px;font-weight:800}
.green{color:#22c55e}.yellow{color:#eab308}.orange{color:#f97316}.red{color:#ef4444}.blue{color:#60a5fa}
.row-sub{font-size:10px;color:#475569;text-align:right}

.bar-bg{height:10px;border-radius:5px;background:#1e293b;margin-top:4px;overflow:hidden}
.bar-fg{height:100%;border-radius:5px;transition:width .3s}

.zone-item{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid #111827}
.zone-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.zone-nm{font-size:12px;color:#94a3b8;flex:1}
.zone-d{font-size:11px;color:#64748b;min-width:60px;text-align:right}
.zone-n{font-size:14px;font-weight:700;min-width:55px;text-align:right}

.alert{border-radius:8px;padding:10px;margin-top:6px}
.alert-r{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25)}
.alert-y{background:rgba(234,179,8,.08);border:1px solid rgba(234,179,8,.25)}
.alert-b{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25)}
.alert-t{font-weight:700;font-size:13px;margin-bottom:3px}
.alert-r .alert-t{color:#f87171}
.alert-y .alert-t{color:#facc15}
.alert-b .alert-t{color:#60a5fa}
.alert-x{font-size:12px;line-height:1.5}
.alert-r .alert-x{color:#fca5a5}
.alert-y .alert-x{color:#fde68a}
.alert-b .alert-x{color:#93c5fd}

.chart-box{width:100%;height:110px}

.peak-box{background:linear-gradient(135deg,rgba(249,115,22,.1),rgba(239,68,68,.08));border:1px solid rgba(249,115,22,.3);border-radius:10px;padding:12px;margin-bottom:10px}
.peak-box h3{color:#fb923c;font-size:13px;font-weight:800;margin-bottom:6px}
.peak-box p{font-size:12px;color:#fdba74;line-height:1.6}
.peak-box strong{color:#fff}

.params{display:grid;grid-template-columns:1fr 1fr;gap:3px 10px}
.params span{font-size:11px}
.params .k{color:#475569}
.params .v{color:#94a3b8;font-weight:600}

.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.leg{display:flex;align-items:center;gap:4px;font-size:11px;color:#64748b}
.leg i{width:16px;height:10px;border-radius:2px;display:inline-block}
</style>
</head>
<body>
<div class="header">
  <div>
    <h1>åŒ—ä¹å·ãƒãƒ©ã‚½ãƒ³2026 EXPO æ··é›‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
    <div class="sub">2026/2/15 (æ—¥) å¤§ä¼šå½“æ—¥ ï½œ 9:00ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ åˆ¶é™6æ™‚é–“ ï½œ å‡ºèµ° ç´„10,000äºº + ä¸€èˆ¬æ¥å ´è€… ç´„1,000äºº</div>
  </div>
  <div class="spd" id="spdGroup">
    <button onclick="setSpd(1)" class="on">Ã—1</button>
    <button onclick="setSpd(5)">Ã—5</button>
    <button onclick="setSpd(15)">Ã—15</button>
    <button onclick="setSpd(30)">Ã—30</button>
  </div>
</div>

<div class="layout">
  <div class="left">
    <div class="map-wrap"><canvas id="C"></canvas></div>
    <div class="ctrl">
      <button class="btn btn-play" id="playBtn" onclick="toggle()">â–¶ å†ç”Ÿ</button>
      <span class="time" id="clock">11:10</span>
      <div class="slider"><input type="range" id="slider" min="0" max="320" value="0" step="0.5" oninput="seek(this.value)"></div>
      <span class="arrived" id="arrived">åˆ°ç€ 0 / 10,000</span>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <div class="card-t">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶</div>
      <div class="params">
        <span class="k">å‡ºèµ°è€…</span><span class="v">ç´„10,000äºº</span>
        <span class="k">ä¸€èˆ¬æ¥å ´è€…</span><span class="v">ç´„1,000äºº</span>
        <span class="k">ã‚¹ã‚¿ãƒ¼ãƒˆ</span><span class="v">9:00</span>
        <span class="k">åˆ¶é™æ™‚é–“</span><span class="v">6æ™‚é–“ (15:00)</span>
        <span class="k">å¹³å‡æ»åœ¨</span><span class="v">15ã€œ20åˆ†</span>
        <span class="k">å…¥å£å¹…</span><span class="v">ç´„5.5m</span>
      </div>
    </div>
    <div class="peak-box" id="peakBox"></div>
    <div class="card">
      <div class="card-t">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ³ <span class="badge badge-live" id="liveBadge" style="display:none">LIVE</span></div>
      <div class="row"><span class="row-l">å ´å†…äººæ•°</span><span class="row-v" id="mOcc">0äºº</span></div>
      <div class="row-sub" id="mOccSub"></div>
      <div class="row"><span class="row-l">ãƒ©ãƒ³ãƒŠãƒ¼å…¥å ´</span><span class="row-v" id="mIn">0äºº/åˆ†</span></div>
      <div class="row"><span class="row-l">é€€å ´</span><span class="row-v" id="mOut">0äºº/åˆ†</span></div>
      <div class="row"><span class="row-l">é€šè·¯å¹³å‡å¯†åº¦</span><span class="row-v" id="mDens">0.00</span></div>
      <div class="bar-bg"><div class="bar-fg" id="mBar"></div></div>
      <div class="row"><span class="row-l">å…¥å£å¾…ã¡è¡Œåˆ—</span><span class="row-v" id="mQ">ãªã—</span></div>
    </div>
    <div class="card">
      <div class="card-t">ã‚¾ãƒ¼ãƒ³åˆ¥æ··é›‘</div>
      <div id="zoneList"></div>
    </div>
    <div class="card">
      <div class="card-t">åˆ°ç€åˆ†å¸ƒ</div>
      <canvas class="chart-box" id="chartC"></canvas>
      <div style="font-size:10px;color:#475569;margin-top:3px">é’=åˆ°ç€ãƒ¬ãƒ¼ãƒˆ ï½œ ã‚ªãƒ¬ãƒ³ã‚¸=å ´å†…äººæ•° ï½œ èµ¤ç·š=ç¾åœ¨</div>
    </div>
    <div class="card">
      <div class="card-t">è­¦å‘Š</div>
      <div id="alerts"></div>
    </div>
    <div class="card">
      <div class="card-t">æ”¹å–„ææ¡ˆ</div>
      <div id="tips"></div>
    </div>
    <div class="card">
      <div class="card-t">å‡¡ä¾‹</div>
      <div class="legend">
        <div class="leg"><i style="background:#22c55e"></i>å¿«é© ã€œ0.5</div>
        <div class="leg"><i style="background:#eab308"></i>æ··é›‘ 0.5ã€œ1.0</div>
        <div class="leg"><i style="background:#f97316"></i>éå¯† 1.0ã€œ2.0</div>
        <div class="leg"><i style="background:#ef4444"></i>å±é™º 2.0ã€œ</div>
      </div>
      <div style="font-size:10px;color:#475569;margin-top:6px">â€» 2.0äºº/mÂ²è¶…ã§æ­©è¡Œå›°é›£ ï½œ ãƒãƒ©ã‚½ãƒ³å¾Œã¯ç–²åŠ´ã§ä½“æ„Ÿ1.5å€</div>
    </div>
  </div>
</div>

<script>
// ===================== CONFIG =====================
const RUNNERS = 10000;
const VISITORS = 1000;
const RACE_START = 540; // 9:00
const TRANSIT_MEAN = 12; // mean 12 minutes from finish to EXPO
const TRANSIT_SD = 5; // Ïƒ=5 (5-25 min range)
const AVG_STAY = 17.5, STAY_SD = 5;
const VISITOR_STAY = 35, VISITOR_SD = 10;
const ENTRY_CAP = 90; // increased from 55 to 90 (5.5m gate more permissive)
const EXIT_CAP = 100; // increased from 65 to 100
const SIM0 = 670; // 11:10
const SIMDUR = 320; // 11:10 + 320åˆ† = 16:30

// ===================== VENUE (y=0 at TOP, matching PDF) =====================
// Coordinates in meters, origin at top-left of venue
const VW = 115, VH = 78;
const canvas = document.getElementById('C');
const ctx = canvas.getContext('2d');
const DPR = Math.min(window.devicePixelRatio||1, 2);
let S, OX, OY;

function resize(){
  const w = canvas.parentElement.clientWidth;
  const h = Math.min(w * VH/VW + 20, window.innerHeight - 160);
  canvas.width = w*DPR; canvas.height = h*DPR;
  canvas.style.height = h+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  S = (w-30)/VW; OX=15; OY=10;
}
function tx(x,y){ return [OX+x*S, OY+y*S]; }

// Zones: äººãŒå®Ÿéš›ã«æ»ç•™ã™ã‚‹ã‚¨ãƒªã‚¢ã®ã¿å®šç¾©
// â€» å‡ºå£å°‚ç”¨ãƒ»å…¥å£å°‚ç”¨ãƒ»ç·åˆæ¡ˆå†…ãƒ»ãƒ­ãƒ“ãƒ¼(y:0-22, x:22-65) ã¯å±‹å¤–/ãƒ›ãƒ¯ã‚¤ã‚¨ã§æ»ç•™ã‚¼ãƒ­ â†’ ã‚¾ãƒ¼ãƒ³å®šç¾©ãªã—
const Z = [
  {id:'left_aisle',   nm:'å·¦å´é€šè·¯(ä¸‹é–¢/åŒ—ä¹å·ã€œãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹é–“)', x:2, y:31, w:20, h:12},
  {id:'mizuno_front',  nm:'ãƒŸã‚ºãƒã€œãƒ–ãƒ¼ã‚¹é–“é€šè·¯',  x:28, y:32, w:42, h:8},
  {id:'center_mid',   nm:'ãƒ–ãƒ¼ã‚¹ä¸­æ®µé€šè·¯',        x:22, y:40, w:58, h:12},
  {id:'center_south', nm:'å—å´é€šè·¯(ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©/ã‚¢ãƒ«ãƒšãƒ³å‰)', x:22, y:52, w:56, h:8},
  {id:'right_aisle',  nm:'å³å´é€šè·¯(æ˜ ç”»ç¥­ã€œ180å¸­é–“)', x:78, y:40, w:10, h:12},
  {id:'entry_area',   nm:'å…¥å£ãƒ»è¨˜éŒ²è¨¼ã‚¨ãƒªã‚¢',     x:2,  y:54, w:20, h:20},
  {id:'rest_stage',   nm:'ä¼‘æ†©ã‚¨ãƒªã‚¢ (180å¸­)',    x:88, y:38, w:14, h:12},
];

// Booths (y-down coords matching PDF)
const B = [
  {nm:'å‡ºå£å°‚ç”¨',       x:48, y:3,  w:12, h:5,  c:'#ef4444'},
  {nm:'å…¥å£å°‚ç”¨',       x:33, y:3,  w:12, h:5,  c:'#22c55e'},
  {nm:'ç·åˆæ¡ˆå†…',       x:33, y:14, w:12, h:5,  c:'#a855f7'},
  {nm:'ãƒŸã‚ºãƒ',         x:28, y:22, w:38, h:10, c:'#3b82f6'},
  {nm:'ä½å·æ€¥ä¾¿',       x:76, y:22, w:10, h:6,  c:'#f97316'},
  {nm:'è·ç‰©ç½®ã',       x:87, y:22, w:10, h:6,  c:'#f97316'},
  {nm:'ä¸‹é–¢æµ·éŸ¿\nãƒãƒ©ã‚½ãƒ³',x:4,y:24, w:8,  h:7,  c:'#8b5cf6'},
  {nm:'åŒ—ä¹å·\nãƒãƒ©ã‚½ãƒ³', x:13, y:24, w:8,  h:7,  c:'#8b5cf6'},
  {nm:'ãƒ•ã‚©ãƒˆã‚¯ãƒªã‚¨ã‚¤ãƒˆ',  x:24, y:40, w:9,  h:6,  c:'#06b6d4'},
  {nm:'æ—¥æœ¬ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',  x:24, y:47, w:10, h:5,  c:'#eab308'},
  {nm:'ã‚®ãƒŸãƒƒã‚¯',        x:35, y:47, w:7,  h:5,  c:'#06b6d4'},
  {nm:'ç¬¬ä¸€ç”Ÿå‘½ä¿é™º',     x:43, y:47, w:10, h:5,  c:'#06b6d4'},
  {nm:'è‹¥é¶´é…’é€ ',        x:34, y:40, w:7,  h:6,  c:'#06b6d4'},
  {nm:'éå’Œã‚¹ãƒãƒ¼ãƒ«',     x:42, y:40, w:7,  h:6,  c:'#06b6d4'},
  {nm:'ãƒ‘ãƒ³å·¥æˆ¿ æ«Ÿ',     x:50, y:40, w:7,  h:6,  c:'#06b6d4'},
  {nm:'åŒ—ä¹å·è¦³å…‰\nã‚³ãƒ³ãƒ™ãƒ³ã‚·ãƒ§ãƒ³',x:58,y:40,w:10,h:6,c:'#06b6d4'},
  {nm:'ä¸‰äº•è£½ç³–',        x:54, y:47, w:6,  h:5,  c:'#06b6d4'},
  {nm:'ã¬ã‹ã ã',        x:61, y:47, w:7,  h:5,  c:'#06b6d4'},
  {nm:'ã‚¼ãƒ³ãƒªãƒ³',        x:69, y:47, w:7,  h:5,  c:'#06b6d4'},
  {nm:'åŒ—ä¹å·å¸‚\næ¼«ç”»ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ',x:69,y:40,w:10,h:6,c:'#06b6d4'},
  {nm:'åŒ—ä¹å·å›½éš›\næ˜ ç”»ç¥­', x:76, y:47, w:8, h:5, c:'#06b6d4'},
  {nm:'ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹è‹¥æ¾',  x:4,  y:40, w:18, h:10,c:'#6366f1'},
  {nm:'ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©åšå¤š',x:22, y:60, w:18, h:7, c:'#22c55e'},
  {nm:'ã‚¢ãƒ«ãƒšãƒ³',        x:44, y:60, w:16, h:7, c:'#22c55e'},
  {nm:'å¤§è‹±ç”£æ¥­',        x:64, y:60, w:14, h:7, c:'#22c55e'},
  {nm:'180å¸­',          x:88, y:40, w:14, h:10, c:'#475569'},
  {nm:'ã‚¹ãƒ†ãƒ¼ã‚¸',        x:102, y:40, w:8, h:10, c:'#475569'},
  {nm:'æ—¥æœ¬é™¸é€£\nè¨˜éŒ²è¨¼ç™ºè¡Œ',x:3,y:56,w:14,h:6, c:'#ec4899'},
  {nm:'ãƒ©ãƒ³ãƒŠãƒ¼\nè·¯è¾ã‚µã‚¤ãƒ³',x:3,y:63,w:10,h:5, c:'#ec4899'},
];

// ===================== CORRIDOR DEFINITION =====================
// Define walkable corridors as polygons/rectangles
// Particles will be confined to these areas
const CORRIDORS = [
  // 1. Bottom entry area (wide, below all booths)
  {x:0, y:68, w:22, h:10},
  // 2. Left side: record cert / signs area (walkable between booths)
  {x:0, y:52, w:22, h:16},
  // 3. Left aisle: between ä¸‹é–¢/åŒ—ä¹å·ãƒãƒ©ã‚½ãƒ³ row and ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹è‹¥æ¾
  {x:0, y:31, w:22, h:12},
  // 4. Center horizontal corridor (between ãƒŸã‚ºãƒ row and mid booths)
  {x:22, y:32, w:48, h:8},
  // 5. Center mid booths area (browsing area)
  {x:22, y:40, w:58, h:12},
  // 6. Right aisle (toward rest area)
  {x:68, y:32, w:8, h:22},
  // 7. 180å¸­ä¼‘æ†©ã‚¨ãƒªã‚¢ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã¯å«ã¾ãªã„ï¼‰
  {x:78, y:38, w:24, h:14},
  // 8. South corridor (between mid and south booth rows)
  {x:22, y:52, w:56, h:8},
  // â€» å‡ºå£å°‚ç”¨ãƒ»å…¥å£å°‚ç”¨ãƒ»ç·åˆæ¡ˆå†…ãƒ»ãƒ­ãƒ“ãƒ¼(y:0-22)ã¯å…¨ã¦é€šéã®ã¿ â†’ ã‚³ãƒªãƒ‰ãƒ¼ãªã—ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é…ç½®ã—ãªã„ï¼‰
];

function isInCorridor(x, y) {
  return CORRIDORS.some(c => x >= c.x && x < c.x + c.w && y >= c.y && y < c.y + c.h);
}

function pushOutOfBooth(x, y) {
  // Check if point is inside any booth, if so push to nearest corridor
  for (let booth of B) {
    if (x >= booth.x && x < booth.x + booth.w && y >= booth.y && y < booth.y + booth.h) {
      // Inside booth, find nearest corridor edge and push out
      let minDist = Infinity;
      let newX = x, newY = y;

      for (let corr of CORRIDORS) {
        // Check all four edges of corridor
        const edges = [
          {sx: corr.x, sy: corr.y, ex: corr.x + corr.w, ey: corr.y, edge: 'top'},
          {sx: corr.x, sy: corr.y + corr.h, ex: corr.x + corr.w, ey: corr.y + corr.h, edge: 'bottom'},
          {sx: corr.x, sy: corr.y, ex: corr.x, ey: corr.y + corr.h, edge: 'left'},
          {sx: corr.x + corr.w, sy: corr.y, ex: corr.x + corr.w, ey: corr.y + corr.h, edge: 'right'},
        ];

        for (let edge of edges) {
          let px, py, dist;
          if (edge.edge === 'top' || edge.edge === 'bottom') {
            py = edge.sy;
            px = Math.max(edge.sx, Math.min(edge.ex, x));
          } else {
            px = edge.sx;
            py = Math.max(edge.sy, Math.min(edge.ey, y));
          }
          dist = Math.hypot(px - x, py - y);
          if (dist < minDist) {
            minDist = dist;
            newX = px;
            newY = py;
          }
        }
      }
      return {x: newX, y: newY};
    }
  }
  return {x, y};
}

// ãƒ©ãƒ³ãƒŠãƒ¼å·¦ãƒ«ãƒ¼ãƒˆ(50%): å…¥å£â†’å·¦é€šè·¯â†’åŒ—ä¹å·/ä¸‹é–¢ãƒãƒ©ã‚½ãƒ³â†’ä¸­å¤®é€šè·¯â†’ä¸Šéƒ¨é€šè·¯â†’å‡ºå£
// â€» ä¸‹é–¢/åŒ—ä¹å·ãƒãƒ©ã‚½ãƒ³ã®ä¸Šã¯ãƒ­ãƒ“ãƒ¼(å£+ãƒˆã‚¤ãƒ¬)ã§é€šè¡Œä¸å¯ã®ãŸã‚ã€ä¸­å¤®é€šè·¯çµŒç”±
const FP_LEFT = [
  {x:10, y:74},  // entry bottom-left
  {x:10, y:60},  // going up left side
  {x:10, y:36},  // left aisle (åŒ—ä¹å·/ä¸‹é–¢ãƒãƒ©ã‚½ãƒ³ã‚¨ãƒªã‚¢)
  {x:35, y:35},  // center corridor (ä¸­å¤®é€šè·¯ã¸åˆæµ)
  {x:55, y:35},  // center corridor ã‚’æ±ã¸
  {x:55, y:19},  // upper corridor (ãƒŸã‚ºãƒä¸Šã®é€šè·¯)
  {x:45, y:12},  // exit corridor
  {x:50, y:4}    // exit gate
];

// ãƒ©ãƒ³ãƒŠãƒ¼å³ãƒ«ãƒ¼ãƒˆ(50%): å…¥å£â†’å—å´ãƒ–ãƒ¼ã‚¹(ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©/ã‚¢ãƒ«ãƒšãƒ³)â†’ä¸­å¤®é€šè·¯â†’å‡ºå£
const FP_RIGHT = [
  {x:10, y:74},  // entry bottom-left
  {x:10, y:60},  // going up left side
  {x:10, y:53},  // south corridor approach
  {x:35, y:53},  // south corridor (ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©å‰)
  {x:55, y:53},  // south corridor (ã‚¢ãƒ«ãƒšãƒ³å‰)
  {x:68, y:35},  // right aisle â†’ center
  {x:45, y:19},  // upper corridor
  {x:45, y:12},  // exit corridor
  {x:50, y:4}    // exit gate
];

// ä¸€èˆ¬æ¥å ´è€…ãƒ‘ã‚¹ (å‡ºå…¥å£ã‹ã‚‰å…¥ã‚Šã€ãƒ–ãƒ¼ã‚¹å·¡å›)
const VP = [
  {x:50, y:4},   // enter at exit gate area
  {x:42, y:12},  // exit corridor
  {x:35, y:19},  // upper corridor
  {x:40, y:35},  // center corridor
  {x:55, y:53},  // south corridor
  {x:35, y:35},  // back to center
  {x:50, y:4}    // exit
];

// ===================== ARRIVAL MODEL (WITH TRANSIT CONVOLUTION) =====================
function gpdf(x,m,s){return Math.exp(-.5*((x-m)/s)**2)/(s*2.5066)}

function finishPDF(rm){
  if(rm<125||rm>370)return 0;
  return .03*RUNNERS*gpdf(rm,145,12)+.12*RUNNERS*gpdf(rm,200,18)+
    .18*RUNNERS*gpdf(rm,228,15)+.22*RUNNERS*gpdf(rm,255,15)+
    .18*RUNNERS*gpdf(rm,285,15)+.15*RUNNERS*gpdf(rm,315,15)+
    .12*RUNNERS*gpdf(rm,345,12);
}

// Convolve finish times with transit time distribution (normal dist: mean=12, Ïƒ=5)
function runnerRate(t){
  const clock = SIM0 + t;
  const TRANSIT_RANGE = 30; // sample Â±3Ïƒ
  let rate = 0;
  for (let transit_offset = -TRANSIT_RANGE; transit_offset <= TRANSIT_RANGE; transit_offset += 0.5) {
    const finish_time = clock - RACE_START - TRANSIT_MEAN - transit_offset;
    const weight = gpdf(transit_offset, 0, TRANSIT_SD);
    rate += finishPDF(finish_time) * weight * 0.5; // 0.5 for dt step
  }
  return rate;
}

// Visitors: arrive matching runner pattern but spread more
function visitorRate(t){
  const clock = SIM0 + t;
  if(clock < 11*60 || clock > 16*60) return 0;
  // gentle bell curve centered at 13:00, wider spread
  return VISITORS * gpdf(t, 110, 60);
}

// Pre-compute arrival and occupancy data
const AD = [], OD = [];
let cumA = 0;
for(let t = 0; t <= SIMDUR; t++){
  const rr = runnerRate(t), vr = visitorRate(t), tot = rr + vr;
  cumA += tot;
  AD.push({t, rr, vr, total: tot, cum: Math.min(cumA, RUNNERS + VISITORS)});
}

function ncdf(x,m,s){return .5*(1+erf2((x-m)/(s*1.4142)))}
function erf2(x){const s=x<0?-1:1;x=Math.abs(x);const t=1/(1+.3275911*x);return s*(1-(((((1.061405429*t-1.453152027)*t)+1.421413741)*t-.284496736)*t+.254829592)*t*Math.exp(-x*x))}

for(let t = 0; t <= SIMDUR; t++){
  let inv = 0;
  const lb = Math.ceil(Math.max(AVG_STAY, VISITOR_STAY) + 3*Math.max(STAY_SD, VISITOR_SD));
  for(let i = Math.max(0, t - lb); i <= t; i++){
    const d = AD[i];
    if(!d) continue;
    const el = t - i;
    inv += d.rr * (1 - ncdf(el, AVG_STAY, STAY_SD));
    inv += d.vr * (1 - ncdf(el, VISITOR_STAY, VISITOR_SD));
  }
  // 16:00ä»¥é™ã¯é–‰å ´ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  const odClock = SIM0 + t;
  if(odClock >= 960){
    inv *= Math.max(0, 1 - (odClock - 960) / 30);
  }
  OD.push(Math.max(0, inv));
}

// ===================== SIMULATION =====================
function sim(t){
  let inv = 0;
  const entR = runnerRate(t) + visitorRate(t);
  const lb = 45;
  for(let i = Math.max(0, Math.floor(t - lb)); i <= Math.min(SIMDUR, Math.floor(t)); i++){
    const d = AD[i];
    if(!d) continue;
    const el = t - i;
    inv += d.rr * Math.max(0, 1 - ncdf(el, AVG_STAY, STAY_SD));
    inv += d.vr * Math.max(0, 1 - ncdf(el, VISITOR_STAY, VISITOR_SD));
  }
  // 16:00ä»¥é™ã¯é–‰å ´ â†’ 16:30ã¾ã§ã«å…¨å“¡é€€å ´ï¼ˆç·šå½¢ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰
  const closeClock = SIM0 + t;
  if(closeClock >= 960){
    const fadeRatio = Math.max(0, 1 - (closeClock - 960) / 30); // 960(16:00)â†’990(16:30)ã§0ã«
    inv *= fadeRatio;
  }
  const exR = runnerRate(Math.max(0, t - AVG_STAY)) + visitorRate(Math.max(0, t - VISITOR_STAY));
  // Queue - now less likely with smoother arrival pattern
  let q = 0;
  const rr = runnerRate(t);
  if(rr > ENTRY_CAP){
    for(let i = Math.max(0, Math.floor(t - 30)); i <= Math.floor(t); i++){
      const r2 = runnerRate(i);
      if(r2 > ENTRY_CAP) q += r2 - ENTRY_CAP;
      else q = Math.max(0, q - (ENTRY_CAP - r2));
    }
  }
  // Zone distribution
  const zo = {};
  Z.forEach(z => {
    let f = 0;
    switch(z.id){
      case'entry_area':f=.15;break;    // å…¥å£ã€œè¨˜éŒ²è¨¼ç™ºè¡Œ
      case'left_aisle':f=.13;break;    // ä¸‹é–¢/åŒ—ä¹å·ãƒãƒ©ã‚½ãƒ³ã€œãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹é–“
      case'mizuno_front':f=.08;break;  // ãƒŸã‚ºãƒå‰é€šè·¯ï¼ˆé€šéãƒ¡ã‚¤ãƒ³ï¼‰
      case'center_mid':f=.25;break;    // ãƒ–ãƒ¼ã‚¹ä¸­æ®µï¼ˆãƒ•ã‚©ãƒˆã‚¯ãƒªã‚¨ã‚¤ãƒˆã€œæ¼«ç”»ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ï¼‹è²·ã„ç‰©ï¼‰
      case'center_south':f=.20;break;  // ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©/ã‚¢ãƒ«ãƒšãƒ³å‰ï¼ˆãã˜å¼•ããƒ»è²·ã„ç‰©ï¼‰
      case'right_aisle':f=.05;break;   // å³å´é€šè·¯
      case'rest_stage':f=.14;break;    // ä¼‘æ†©180å¸­
    }
    let p = inv * f;
    // 180å¸­ã‚¨ãƒªã‚¢: 15:00ã€œ16:00ã¯å‰ç”°é¦™ç¹”ãƒˆãƒ¼ã‚¯ã‚·ãƒ§ãƒ¼ã§180äººæº€å¸­ã€ãã‚Œä»¥å¤–ã¯150äººã‚­ãƒ£ãƒƒãƒ—
    if(z.id === 'rest_stage'){
      const clock = SIM0 + t;
      if(clock >= 900 && clock <= 960){
        // 15:00ã€œ16:00: ãƒˆãƒ¼ã‚¯ã‚·ãƒ§ãƒ¼æ™‚é–“å¸¯ â†’ 180å¸­æº€å¸­
        p = 180;
      } else if(clock >= 870 && clock < 900){
        // 14:30ã€œ15:00: å¾ã€…ã«å¸­ãŒåŸ‹ã¾ã‚‹ (150â†’180ã¸ç·šå½¢è£œé–“)
        const ratio = (clock - 870) / 30;
        p = Math.min(p, Math.round(150 + 30 * ratio));
      } else if(clock > 960 && clock <= 975){
        // 16:00ã€œ16:15: å¾ã€…ã«é€€å¸­ (180â†’é€šå¸¸ã¸)
        const ratio = (clock - 960) / 15;
        p = Math.min(p, Math.round(180 - 30 * ratio));
      } else {
        p = Math.min(p, 150);
      }
    }
    const a = z.w * z.h, d = p / a;
    zo[z.id] = {p: Math.round(p), d, a};
  });
  return {
    inv: Math.round(inv),
    entR,
    exR,
    zo,
    entU: Math.min(rr / ENTRY_CAP, 2),
    exU: Math.min(exR / EXIT_CAP, 2),
    q: Math.round(q),
    cum: Math.round(AD[Math.min(Math.floor(t), SIMDUR)]?.cum || 0)
  };
}

// ===================== DRAWING =====================
function dc(d,a){
  if(a===undefined)a=1;
  if(d<.3)return`rgba(34,197,94,${a})`;if(d<.5)return`rgba(132,204,22,${a})`;
  if(d<1)return`rgba(234,179,8,${a})`;if(d<2)return`rgba(249,115,22,${a})`;
  return`rgba(239,68,68,${a})`;
}
function dcs(d){
  if(d<.3)return'#22c55e';if(d<.5)return'#84cc16';
  if(d<1)return'#eab308';if(d<2)return'#f97316';return'#ef4444';
}

function draw(s){
  const w = canvas.width/DPR, h = canvas.height/DPR;
  ctx.clearRect(0,0,w,h);
  // Venue bg
  const[fx,fy] = tx(0,0);
  ctx.fillStyle='#0d1525';
  ctx.strokeStyle='#1e293b';ctx.lineWidth=2;
  ctx.beginPath();ctx.rect(fx,fy,VW*S,VH*S);ctx.fill();ctx.stroke();

  // Zone heat
  Z.forEach(z => {
    const d = s.zo[z.id];
    if(!d) return;
    const[zx,zy] = tx(z.x,z.y);
    const zw = z.w*S, zh = z.h*S;
    // Radial gradient
    const cx2 = zx+zw/2, cy2 = zy+zh/2;
    const r = Math.max(zw,zh)*.7;
    const g = ctx.createRadialGradient(cx2,cy2,0,cx2,cy2,r);
    g.addColorStop(0, dc(d.d,.55));
    g.addColorStop(1, dc(d.d,.15));
    ctx.fillStyle = g;
    ctx.beginPath();ctx.roundRect(zx,zy,zw,zh,6);ctx.fill();
    // border glow when crowded
    if(d.d>.5){
      ctx.strokeStyle = dc(d.d,.4);ctx.lineWidth=2;
      ctx.beginPath();ctx.roundRect(zx,zy,zw,zh,6);ctx.stroke();
    }
  });

  // Booths
  B.forEach(b => {
    const[bx,by] = tx(b.x,b.y);
    const bw = b.w*S, bh = b.h*S;
    ctx.fillStyle = b.c+'30';ctx.strokeStyle = b.c+'66';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(bx,by,bw,bh,3);ctx.fill();ctx.stroke();
    ctx.fillStyle='#556677';
    const fs = Math.max(7, Math.min(11, bw/6));
    ctx.font=`bold ${fs}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';
    b.nm.split('\n').forEach((l,i,a) => {
      ctx.fillText(l, bx+bw/2, by+bh/2+(i-(a.length-1)/2)*(fs+1));
    });
  });

  // Flow paths (2 routes)
  ctx.lineWidth=2;ctx.setLineDash([6,4]);
  ctx.strokeStyle='rgba(96,165,250,.2)';
  ctx.beginPath();
  FP_LEFT.forEach((p,i) => { const[px,py]=tx(p.x,p.y); i?ctx.lineTo(px,py):ctx.moveTo(px,py); });
  ctx.stroke();
  ctx.strokeStyle='rgba(250,204,21,.15)';
  ctx.beginPath();
  FP_RIGHT.forEach((p,i) => { const[px,py]=tx(p.x,p.y); i?ctx.lineTo(px,py):ctx.moveTo(px,py); });
  ctx.stroke();
  ctx.setLineDash([]);

  // Animated particles (now constrained to corridors)
  drawParts(s);

  // Big zone badges
  Z.forEach(z => {
    const d = s.zo[z.id];
    if(!d || d.p < 10) return;  // 10äººæœªæº€ã®ã‚¾ãƒ¼ãƒ³ã¯ãƒãƒƒã‚¸éè¡¨ç¤º
    const[zx,zy] = tx(z.x,z.y);
    const zw = z.w*S, zh = z.h*S;
    const cx2 = zx+zw/2, cy2 = zy+zh/2;
    if(d.d>.2){
      const label = `${d.p}äºº`;
      ctx.font='bold 14px sans-serif';
      const tw = ctx.measureText(label).width;
      const bw2 = tw+16, bh2 = 24;
      // Background pill
      ctx.fillStyle = dc(d.d,.9);
      ctx.beginPath();ctx.roundRect(cx2-bw2/2,cy2-bh2/2,bw2,bh2,12);ctx.fill();
      // Shadow
      ctx.shadowColor='rgba(0,0,0,.4)';ctx.shadowBlur=6;
      ctx.fillStyle='#fff';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.font='bold 14px sans-serif';
      ctx.fillText(label,cx2,cy2);
      ctx.shadowBlur=0;
      // Density sub-label
      if(zh>30){
        ctx.fillStyle='rgba(255,255,255,.65)';
        ctx.font='10px sans-serif';
        ctx.fillText(`${d.d.toFixed(1)}äºº/mÂ²`,cx2,cy2+14);
      }
    }
  });

  // Entry / Exit indicators
  const[ex2,ey2] = tx(2,74);
  ctx.fillStyle='#22c55e';ctx.font='bold 13px sans-serif';ctx.textAlign='left';
  ctx.fillText('â–² ãƒ©ãƒ³ãƒŠãƒ¼å…¥å£',ex2,ey2+4);
  if(s.q>20){
    ctx.fillStyle='#ef4444';ctx.font='bold 12px sans-serif';
    ctx.fillText(`å¾…ã¡è¡Œåˆ— ç´„${s.q}äºº`,ex2+120,ey2+4);
  }

  const[ox2,oy2] = tx(48,0);
  ctx.fillStyle='#ef4444';ctx.font='bold 13px sans-serif';ctx.textAlign='center';
  ctx.fillText('â–¼ å‡ºå£',ox2+10,oy2-3);

  // Top gate utilization
  drawBar(42,0,s.entU,'å…¥å£',90);
  drawBar(62,0,s.exU,'å‡ºå£',90);
}

function drawBar(mx,my,u,label,bw){
  const[bx,by] = tx(mx,my);
  const y2 = by-14;
  ctx.fillStyle='#1e293b';ctx.beginPath();ctx.roundRect(bx,y2,bw,6,3);ctx.fill();
  ctx.fillStyle = u>1?'#ef4444':u>.7?'#f97316':'#22c55e';
  ctx.beginPath();ctx.roundRect(bx,y2,Math.min(u/1.5,1)*bw,6,3);ctx.fill();
  ctx.fillStyle='#64748b';ctx.font='9px sans-serif';ctx.textAlign='left';
  ctx.fillText(`${label}${Math.round(Math.min(u,1.5)*100)}%`,bx,y2-3);
}

// ===================== ã‚¾ãƒ¼ãƒ³åˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ  =====================
// å„ã‚¾ãƒ¼ãƒ³ã®äººæ•°ã«å¿œã˜ã¦ãã®ã‚¾ãƒ¼ãƒ³å†…ã«ãƒ‰ãƒƒãƒˆã‚’é…ç½®
// ãƒ–ãƒ¼ã‚¹å‰ã«ã¯æ»ç•™ã™ã‚‹äººã‚’è¡¨ç¾ã€æ··é›‘æ™‚ã¯ç§»å‹•é€Ÿåº¦ä½ä¸‹

// ãƒ–ãƒ¼ã‚¹å‰ã«äººãŒãŸã¾ã‚‹ã€Œæ»ç•™ãƒã‚¤ãƒ³ãƒˆã€å®šç¾©
// å„ãƒ–ãƒ¼ã‚¹ã®æ‰‹å‰(é€šè·¯å´)ã«æ»ç•™ã‚¨ãƒªã‚¢ã‚’è¨­å®š
const DWELL_POINTS = [
  {nm:'ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©', x:22, y:57, w:18, h:3, cap:40},  // ãã˜å¼•ãå¾…ã¡
  {nm:'ã‚¢ãƒ«ãƒšãƒ³',      x:44, y:57, w:16, h:3, cap:35},   // è²·ã„ç‰©
  {nm:'å¤§è‹±ç”£æ¥­',      x:64, y:57, w:14, h:3, cap:20},
  {nm:'ãƒŸã‚ºãƒ',        x:28, y:32, w:38, h:3, cap:50},   // å¤§å‹ãƒ–ãƒ¼ã‚¹
  {nm:'ãƒ•ã‚©ãƒˆã‚¯ãƒªã‚¨ã‚¤ãƒˆ',x:24, y:46, w:9, h:2, cap:15},
  {nm:'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',   x:24, y:52, w:10, h:2, cap:20},
  {nm:'ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹è‹¥æ¾',x:4, y:38, w:18, h:2, cap:25},
  {nm:'180å¸­ä¼‘æ†©',     x:85, y:38, w:16, h:10, cap:60},  // ä¼‘æ†©ã‚¨ãƒªã‚¢
];

let parts = [];
let zoneParts = {}; // ã‚¾ãƒ¼ãƒ³åˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç®¡ç†

// ã‚¾ãƒ¼ãƒ³å†…ã®ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®(ãƒ–ãƒ¼ã‚¹å†…ã‚’é¿ã‘ã‚‹)
function randInZone(z){
  for(let t=0;t<30;t++){
    const x = z.x + Math.random()*z.w;
    const y = z.y + Math.random()*z.h;
    // ãƒ–ãƒ¼ã‚¹å†…ãƒã‚§ãƒƒã‚¯
    let inBooth = false;
    for(const b of B){
      if(x>=b.x && x<b.x+b.w && y>=b.y && y<b.y+b.h){ inBooth=true; break; }
    }
    if(!inBooth) return {x,y};
  }
  return {x: z.x+z.w/2, y: z.y+z.h/2};
}

function drawParts(s){
  // å…¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦å„ã‚¾ãƒ¼ãƒ³ã«å†é…ç½®(æ¯ãƒ•ãƒ¬ãƒ¼ãƒ )
  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã€æ—¢å­˜ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã¯ä½ç½®ã‚’å¾®èª¿æ•´ã™ã‚‹ã ã‘

  const totalTarget = Math.min(Math.round(s.inv), 3000);

  // ã‚¾ãƒ¼ãƒ³åˆ¥ã®ç›®æ¨™ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•°ã‚’è¨ˆç®—
  const zoneTargets = {};
  Z.forEach(z => {
    const d = s.zo[z.id];
    if(!d) return;
    zoneTargets[z.id] = Math.round(d.p * (totalTarget / Math.max(s.inv,1)));
  });

  // åˆå› or ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•°ãŒå¤§ããå¤‰ã‚ã£ãŸã‚‰å†æ§‹ç¯‰
  if(Math.abs(parts.length - totalTarget) > totalTarget*0.3 || parts.length === 0){
    parts = [];
    Z.forEach(z => {
      const n = zoneTargets[z.id] || 0;
      for(let i=0;i<n;i++){
        const pos = randInZone(z);
        // ä¸€å®šå‰²åˆã‚’ãƒ–ãƒ¼ã‚¹å‰æ»ç•™ãƒã‚¤ãƒ³ãƒˆã«é…ç½®
        let dwelling = false;
        for(const dp of DWELL_POINTS){
          if(pos.x >= dp.x && pos.x < dp.x+dp.w && pos.y >= dp.y && pos.y < dp.y+dp.h){
            dwelling = true; break;
          }
        }
        parts.push({
          x:pos.x, y:pos.y, zid:z.id,
          vx:(Math.random()-.5)*.06, vy:(Math.random()-.5)*.06,
          life:80+Math.random()*160,
          dwelling: dwelling,
          dwellTimer: dwelling ? 30+Math.random()*60 : 0,
          col: Math.random()<.1 ? 'rgba(251,191,36,' : 'rgba(96,165,250,'
        });
      }
    });
  }

  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•°ã®å¢—æ¸›
  while(parts.length < totalTarget){
    const zids = Object.keys(zoneTargets);
    const zid = zids[Math.floor(Math.random()*zids.length)];
    const z = Z.find(zz=>zz.id===zid);
    if(!z) break;
    const pos = randInZone(z);
    parts.push({
      x:pos.x, y:pos.y, zid,
      vx:(Math.random()-.5)*.06, vy:(Math.random()-.5)*.06,
      life:80+Math.random()*160, dwelling:false, dwellTimer:0,
      col: Math.random()<.1 ? 'rgba(251,191,36,' : 'rgba(96,165,250,'
    });
  }
  while(parts.length > totalTarget) parts.pop();

  // æç”» + ç‰©ç†æ›´æ–°
  parts.forEach(p => {
    // æ‰€å±ã‚¾ãƒ¼ãƒ³ã®å¯†åº¦ã‚’å–å¾—
    const zd = s.zo[p.zid];
    const density = zd ? zd.d : 0;

    // æ··é›‘ã«ã‚ˆã‚‹é€Ÿåº¦ä½ä¸‹: å¯†åº¦ãŒé«˜ã„ã»ã©é…ã
    const speedMult = density > 1.5 ? 0.02 : density > 1 ? 0.04 : density > 0.5 ? 0.06 : 0.1;

    // æ»ç•™ä¸­ã¯ã»ã¼å‹•ã‹ãªã„
    if(p.dwelling && p.dwellTimer > 0){
      p.dwellTimer -= 0.3;
      p.x += (Math.random()-.5)*0.02;  // å¾®å°ãªæºã‚Œã®ã¿
      p.y += (Math.random()-.5)*0.02;
    } else {
      p.dwelling = false;
      p.x += p.vx * speedMult * 3;
      p.y += p.vy * speedMult * 3;
      // ãƒ©ãƒ³ãƒ€ãƒ ã«æ–¹å‘è»¢æ›
      if(Math.random()<.02){ p.vx=(Math.random()-.5)*.1; p.vy=(Math.random()-.5)*.1; }

      // ãƒ–ãƒ¼ã‚¹å‰ã«æ¥ãŸã‚‰æ»ç•™é–‹å§‹(ç¢ºç‡30%)
      if(Math.random()<.005){
        for(const dp of DWELL_POINTS){
          if(p.x>=dp.x && p.x<dp.x+dp.w && p.y>=dp.y && p.y<dp.y+dp.h){
            p.dwelling=true; p.dwellTimer=20+Math.random()*40; break;
          }
        }
      }
    }

    // ãƒ–ãƒ¼ã‚¹å†…ã«å…¥ã£ãŸã‚‰æŠ¼ã—å‡ºã™
    for(const b of B){
      if(p.x>=b.x && p.x<b.x+b.w && p.y>=b.y && p.y<b.y+b.h){
        // æœ€çŸ­æ–¹å‘ã«æŠ¼ã—å‡ºã™
        const dL=p.x-b.x, dR=b.x+b.w-p.x, dT=p.y-b.y, dB=b.y+b.h-p.y;
        const mn=Math.min(dL,dR,dT,dB);
        if(mn===dL) p.x=b.x-0.5; else if(mn===dR) p.x=b.x+b.w+0.5;
        else if(mn===dT) p.y=b.y-0.5; else p.y=b.y+b.h+0.5;
      }
    }

    // ã‚¾ãƒ¼ãƒ³å†…ã«ç•™ã‚ã‚‹
    const z = Z.find(zz=>zz.id===p.zid);
    if(z){
      p.x = Math.max(z.x, Math.min(z.x+z.w, p.x));
      p.y = Math.max(z.y, Math.min(z.y+z.h, p.y));
    }

    p.life -= .15;
    if(p.life<0){
      // ãƒªã‚¹ãƒãƒ¼ãƒ³
      if(z){ const pos=randInZone(z); p.x=pos.x; p.y=pos.y; }
      p.life=80+Math.random()*160;
    }

    // æç”»: å¤§ãã‚ãƒ‰ãƒƒãƒˆ + æ··é›‘æ™‚ã¯ã•ã‚‰ã«å¼·èª¿
    const[cx2,cy2] = tx(p.x, p.y);
    const alpha = Math.min(.85, .4 + density*0.3);
    const radius = density > 1 ? 3.5 : density > 0.5 ? 3 : 2.5;
    ctx.fillStyle = p.col + alpha + ')';
    ctx.beginPath(); ctx.arc(cx2,cy2,radius,0,6.28); ctx.fill();

    // æ··é›‘ã‚¨ãƒªã‚¢ã§ã¯ãƒ‰ãƒƒãƒˆã«ã‚°ãƒ­ãƒ¼åŠ¹æœ
    if(density > 0.8){
      ctx.fillStyle = p.col + (alpha*0.2) + ')';
      ctx.beginPath(); ctx.arc(cx2,cy2,radius+2,0,6.28); ctx.fill();
    }
  });
}

// ===================== SIDEBAR =====================
function updateUI(s){
  const occ = document.getElementById('mOcc');
  occ.textContent = s.inv.toLocaleString()+'äºº';
  occ.className = 'row-v ' + (s.inv>2500?'red':s.inv>1800?'orange':s.inv>1000?'yellow':'green');
  document.getElementById('mOccSub').textContent = `ãƒ”ãƒ¼ã‚¯${pkOcc.toLocaleString()}äººã®${Math.round(s.inv/pkOcc*100)}%`;

  const ir = document.getElementById('mIn');
  ir.textContent = Math.round(s.entR)+'äºº/åˆ†';
  ir.className = 'row-v ' + (s.entR>ENTRY_CAP?'red':s.entR>ENTRY_CAP*.7?'orange':'green');
  document.getElementById('mOut').textContent = Math.round(s.exR)+'äºº/åˆ†';

  const azs = Z.filter(z => z.id!=='rest_stage');
  const tA = azs.reduce((a,z) => a+z.w*z.h, 0);
  const tP = azs.reduce((a,z) => a+(s.zo[z.id]?.p||0), 0);
  const ad = tP/tA;
  const de = document.getElementById('mDens');
  de.textContent = ad.toFixed(2)+'äºº/mÂ²';
  de.className = 'row-v ' + (ad>1.5?'red':ad>1?'orange':ad>.5?'yellow':'green');
  const bar = document.getElementById('mBar');
  bar.style.width = Math.min(100, ad/2.5*100)+'%';
  bar.style.background = dcs(ad);

  const qe = document.getElementById('mQ');
  if(s.q>10){
    qe.textContent = `ç´„${s.q}äºº (${Math.round(s.q/ENTRY_CAP)}åˆ†å¾…ã¡)`;
    qe.className = 'row-v ' + (s.q>100?'red':'orange');
  } else {
    qe.textContent = 'ãªã—';
    qe.className = 'row-v green';
  }

  document.getElementById('arrived').textContent = `åˆ°ç€ ${s.cum.toLocaleString()} / ${(RUNNERS+VISITORS).toLocaleString()}`;

  // Zones
  const zl = document.getElementById('zoneList');
  zl.innerHTML = '';
  Z.forEach(z => {
    const d = s.zo[z.id];
    if(!d) return;
    zl.innerHTML += `<div class="zone-item"><div class="zone-dot" style="background:${dcs(d.d)}"></div><span class="zone-nm">${z.nm}</span><span class="zone-d">${d.d.toFixed(2)}äºº/mÂ²</span><span class="zone-n" style="color:${dcs(d.d)}">${d.p}äºº</span></div>`;
  });

  // Alerts
  const ae = document.getElementById('alerts');
  ae.innerHTML = '';
  const al = [];
  if(s.entU>.85){
    const w2 = Math.round(s.q/ENTRY_CAP);
    al.push({c:'r',t:`å…¥å£æ¸‹æ» â€” è² è·${Math.round(s.entU*100)}%`,x:`åˆ°ç€${Math.round(s.entR)}äºº/åˆ† vs å‡¦ç†${ENTRY_CAP}äºº/åˆ†ã€‚æ¨å®š${w2}åˆ†å¾…ã¡ã€‚ç–²åŠ´ãƒ©ãƒ³ãƒŠãƒ¼ãŒå±‹å¤–ã§ç«‹ã¡ç¶šã‘ã‚‹ãƒªã‚¹ã‚¯ã€‚`});
  }
  const cm = s.zo.center_mid;
  if(cm && cm.d>0.8){
    al.push({c:'y',t:`ãƒ–ãƒ¼ã‚¹ä¸­æ®µæ··é›‘ â€” ${cm.d.toFixed(1)}äºº/mÂ²`,x:`${cm.p}äººãŒãƒ•ã‚©ãƒˆã‚¯ãƒªã‚¨ã‚¤ãƒˆã€œæ¼«ç”»ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ å‘¨è¾ºã«é›†ä¸­ã€‚è²·ã„ç‰©ãƒ»ã‚¬ãƒ©ãƒãƒ³ã§æ»ç•™ã€‚`});
  }
  const cs = s.zo.center_south;
  if(cs && cs.d>0.8){
    al.push({c:'y',t:`å—å´é€šè·¯æ··é›‘ â€” ${cs.d.toFixed(1)}äºº/mÂ²`,x:`ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©/ã‚¢ãƒ«ãƒšãƒ³å‰ã«${cs.p}äººã€‚ãã˜å¼•ããƒ»è²·ã„ç‰©ã§æ»ç•™ç™ºç”Ÿã€‚`});
  }
  // å‡ºå£é€šè·¯ï¼ˆãƒ­ãƒ“ãƒ¼ï¼‰ã¯é€šéã®ã¿ãªã®ã§ã‚¢ãƒ©ãƒ¼ãƒˆä¸è¦
  if(s.inv>2000){
    al.push({c:'r',t:'ä¼šå ´åå®¹é™ç•Œæ¥è¿‘',x:`åŒæ™‚${s.inv.toLocaleString()}äººã€‚é¿é›£æ™‚ã®å®‰å…¨ç¢ºä¿ãŒå›°é›£ãªå¯†åº¦ã€‚`});
  }
  if(!al.length){
    ae.innerHTML = '<div style="color:#475569;font-size:12px;padding:6px 0">ç¾åœ¨ã€é‡å¤§ãªè­¦å‘Šãªã—</div>';
  } else {
    al.forEach(a => {
      ae.innerHTML += `<div class="alert alert-${a.c}"><div class="alert-t">${a.t}</div><div class="alert-x">${a.x}</div></div>`;
    });
  }

  // Tips
  const te = document.getElementById('tips');
  te.innerHTML = '';
  const tp = [];
  if(s.entU>.6 || s.q>20){
    tp.push({t:'å…¥å£æ‹¡å¹… + è¨˜éŒ²è¨¼åˆ†é›¢',x:'å…¥å£ã‚’8ã€œ10mã«æ‹¡å¹…ã—ã€è¨˜éŒ²è¨¼ç™ºè¡Œã‚’åˆ¥ãƒ–ãƒ¼ã‚¹ã¸åˆ†é›¢ã€‚å…¥å£ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ70%å‘ä¸Šã€‚'});
  }
  if(cm && cm.d>.6){
    tp.push({t:'ä¸­æ®µãƒ–ãƒ¼ã‚¹ã®å‹•ç·šåˆ†é›¢',x:'é€šéè€…ã¨ãƒ–ãƒ¼ã‚¹ç«‹ã¡å¯„ã‚Šè€…ã®å‹•ç·šã‚’åˆ†é›¢ã€‚ãƒ–ãƒ¼ã‚¹å‰ã«ä¸¦ã³åˆ—ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã€‚'});
  }
  if(s.inv>1500){
    tp.push({t:'å‡ºå£ã®2ç³»çµ±åŒ–',x:'ã€Œå…¥å£å°‚ç”¨ã€ã‚²ãƒ¼ãƒˆã‚’åˆå¾Œã¯å‡ºå£ã«ã‚‚é–‹æ”¾ã€‚é€€å ´å‡¦ç†èƒ½åŠ›2å€ã€‚'});
  }
  tp.push({t:'ãƒ”ãƒ¼ã‚¯æ™‚ã®é€Ÿé”ãƒ«ãƒ¼ãƒˆ',x:'13:00ã€œ14:30ã¯ã€Œè·ç‰©å—å–â†’å³é€€å ´ã€ã®å°‚ç”¨ãƒ¬ãƒ¼ãƒ³ã‚’è¨­ç½®ã€‚æ»åœ¨10åˆ†ä»¥ä¸‹ã§ãƒ”ãƒ¼ã‚¯äººæ•°40%å‰Šæ¸›ã€‚'});
  if(s.zo.rest_stage?.d>.4){
    tp.push({t:'ä¼‘æ†©å¸­ã®å¢—è¨­',x:'180å¸­ã§ã¯ä¸è¶³ã€‚å—å´ãƒ–ãƒ¼ã‚¹å‰ã«ä»®è¨­ãƒ™ãƒ³ãƒ200å¸­è¿½åŠ ã‚’æ¨å¥¨ã€‚'});
  }
  tp.forEach(t => {
    te.innerHTML += `<div class="alert alert-b"><div class="alert-t">ğŸ’¡ ${t.t}</div><div class="alert-x">${t.x}</div></div>`;
  });

  document.getElementById('liveBadge').style.display = playing?'inline-block':'none';
}

// ===================== CHART =====================
function drawChart(ct){
  const c = document.getElementById('chartC');
  const x2 = c.getContext('2d');
  c.width = c.clientWidth*DPR;
  c.height = c.clientHeight*DPR;
  x2.setTransform(DPR,0,0,DPR,0,0);
  const w = c.clientWidth, h = c.clientHeight;
  x2.clearRect(0,0,w,h);
  const mR = Math.max(...AD.map(d=>d.total));
  const mO = Math.max(...OD);
  const p = {l:32, r:32, t:5, b:18};
  const cw = w-p.l-p.r, ch = h-p.t-p.b;
  // Grid
  x2.strokeStyle='#111827';x2.lineWidth=.5;
  for(let i=0; i<=4; i++){
    const y = p.t+ch*i/4;
    x2.beginPath();x2.moveTo(p.l,y);x2.lineTo(w-p.r,y);x2.stroke();
  }
  // Rate area
  x2.beginPath();x2.moveTo(p.l,p.t+ch);
  AD.forEach(d => {
    x2.lineTo(p.l+(d.t/SIMDUR)*cw, p.t+ch-(d.total/mR)*ch);
  });
  x2.lineTo(p.l+cw,p.t+ch);x2.closePath();
  const g = x2.createLinearGradient(0,p.t,0,p.t+ch);
  g.addColorStop(0,'rgba(59,130,246,.3)');
  g.addColorStop(1,'rgba(59,130,246,.02)');
  x2.fillStyle = g;
  x2.fill();
  x2.beginPath();
  AD.forEach((d,i) => {
    const xx = p.l+(d.t/SIMDUR)*cw, yy = p.t+ch-(d.total/mR)*ch;
    i ? x2.lineTo(xx,yy) : x2.moveTo(xx,yy);
  });
  x2.strokeStyle='#3b82f6';x2.lineWidth=1.5;x2.stroke();
  // Occ line
  x2.beginPath();
  OD.forEach((o,t) => {
    const xx = p.l+(t/SIMDUR)*cw, yy = p.t+ch-(o/mO)*ch;
    t ? x2.lineTo(xx,yy) : x2.moveTo(xx,yy);
  });
  x2.strokeStyle='#f97316';x2.lineWidth=1.5;x2.stroke();
  // Danger line
  if(mO>2000){
    const dy = p.t+ch-(2000/mO)*ch;
    x2.strokeStyle='rgba(239,68,68,.35)';x2.lineWidth=1;x2.setLineDash([4,4]);
    x2.beginPath();x2.moveTo(p.l,dy);x2.lineTo(w-p.r,dy);x2.stroke();x2.setLineDash([]);
    x2.fillStyle='rgba(239,68,68,.5)';x2.font='9px sans-serif';x2.textAlign='right';
    x2.fillText('å±é™º',w-p.r-2,dy-2);
  }
  // Now line
  const nx = p.l+(ct/SIMDUR)*cw;
  x2.strokeStyle='#ef4444';x2.lineWidth=1.5;x2.setLineDash([3,3]);
  x2.beginPath();x2.moveTo(nx,p.t);x2.lineTo(nx,p.t+ch);x2.stroke();x2.setLineDash([]);
  // Labels
  x2.fillStyle='#475569';x2.font='10px sans-serif';x2.textAlign='center';
  ['11:10','12:00','13:00','14:00','15:00','16:00','16:30'].forEach((l,i) => {
    const ts = [0,50,110,170,230,290,320];
    x2.fillText(l, p.l+(ts[i]/SIMDUR)*cw, h-3);
  });
  x2.textAlign='right';x2.fillStyle='#3b82f6';x2.fillText(Math.round(mR)+'äºº/åˆ†',p.l-2,p.t+10);
  x2.textAlign='left';x2.fillStyle='#f97316';x2.fillText(Math.round(mO)+'äºº',w-p.r+2,p.t+10);
}

// ===================== PEAKS =====================
let pkOcc = 0, pkT = 0, pkR = 0, pkRT = 0;
function peaks(){
  for(let t = 0; t <= SIMDUR; t++){
    if(OD[t] > pkOcc){
      pkOcc = Math.round(OD[t]);
      pkT = t;
    }
    const r = AD[t]?.total||0;
    if(r > pkR){
      pkR = r;
      pkRT = t;
    }
  }
  const c1 = SIM0+pkT, h1 = Math.floor(c1/60), m1 = c1%60;
  const c2 = SIM0+pkRT, h2 = Math.floor(c2/60), m2 = c2%60;
  const aZ = Z.filter(z => z.id !== 'rest_stage');
  const aA = aZ.reduce((a,z) => a+z.w*z.h, 0);
  const pD = (pkOcc*.73)/aA;
  // ãƒ–ãƒ¼ã‚¹ä¸­æ®µï¼ˆæœ€ã‚‚æ··ã‚€ã‚¨ãƒªã‚¢ï¼‰
  const cmZ = Z.find(z => z.id==='center_mid');
  const cmP = Math.round(pkOcc*.25), cmD = cmP/(cmZ.w*cmZ.h);
  // å—å´é€šè·¯ (ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©/ã‚¢ãƒ«ãƒšãƒ³æ–¹é¢)
  const csZ = Z.find(z => z.id==='center_south');
  const csP = Math.round(pkOcc*.20), csD = csP/(csZ.w*csZ.h);
  document.getElementById('peakBox').innerHTML = `
    <h3>âš¡ ãƒ”ãƒ¼ã‚¯åˆ†æ</h3><p>
    <strong>å ´å†…ãƒ”ãƒ¼ã‚¯:</strong> ${h1}:${String(Math.floor(m1)).padStart(2,'0')}é ƒ â€” ç´„${pkOcc.toLocaleString()}äººåŒæ™‚æ»åœ¨<br>
    <strong>åˆ°ç€ãƒ”ãƒ¼ã‚¯:</strong> ${h2}:${String(Math.floor(m2)).padStart(2,'0')}é ƒ â€” ${Math.round(pkR)}äºº/åˆ†<br>
    <strong>é€šè·¯å¯†åº¦:</strong> ãƒ”ãƒ¼ã‚¯æ™‚ ç´„${pD.toFixed(1)}äºº/mÂ²${pD>1.5?' âš å±é™º':pD>1?' âš æ³¨æ„':''}<br>
    <strong>ãƒ–ãƒ¼ã‚¹ä¸­æ®µ:</strong> ç´„${cmP}äºº (${cmD.toFixed(1)}äºº/mÂ²)${cmD>1?' âš æ³¨æ„':''}<br>
    <strong>å—å´(ãƒˆãƒ¨ã‚¿/ã‚¢ãƒ«ãƒšãƒ³å‰):</strong> ç´„${csP}äºº (${csD.toFixed(1)}äºº/mÂ²)${csD>1?' âš æ³¨æ„':''}<br>
    <strong>å…¥å£:</strong> ãƒ”ãƒ¼ã‚¯${Math.round(pkR)}äºº/åˆ† vs å‡¦ç†${ENTRY_CAP}äºº/åˆ† â†’ ${pkR>ENTRY_CAP?'ğŸ”´å¾…ã¡è¡Œåˆ—ç™ºç”Ÿ':'âœ…å‡¦ç†å¯èƒ½'}</p>`;
}

// ===================== CONTROLS =====================
let curT = 0, playing = false, spd = 1, af = null, lastT = 0;
function toggle(){
  playing = !playing;
  const b = document.getElementById('playBtn');
  if(playing){
    b.textContent = 'â¸ åœæ­¢';
    b.classList.add('on');
    lastT = performance.now();
    anim();
  } else {
    b.textContent = 'â–¶ å†ç”Ÿ';
    b.classList.remove('on');
    if(af) cancelAnimationFrame(af);
  }
}
function setSpd(s){
  spd = s;
  document.querySelectorAll('#spdGroup button').forEach(b => {
    b.classList.toggle('on', parseInt(b.textContent.replace('Ã—','')) === s);
  });
}
function anim(){
  if(!playing) return;
  const now = performance.now(), dt = (now-lastT)/1000;
  lastT = now;
  curT += dt*spd*.5;
  if(curT > SIMDUR){
    curT = SIMDUR;
    playing = false;
    document.getElementById('playBtn').textContent = 'â–¶ å†ç”Ÿ';
    document.getElementById('playBtn').classList.remove('on');
  }
  document.getElementById('slider').value = curT;
  upd(curT);
  af = requestAnimationFrame(anim);
}
function seek(v){
  curT = parseFloat(v);
  upd(curT);
}
function upd(t){
  const c = SIM0+t, hh = Math.floor(c/60), mm = Math.floor(c%60);
  document.getElementById('clock').textContent = `${hh}:${String(mm).padStart(2,'0')}`;
  const s = sim(t);
  draw(s);
  updateUI(s);
  drawChart(t);
}

// ===================== INIT =====================
window.addEventListener('resize', () => {
  resize();
  upd(curT);
});
resize();
peaks();
upd(0);
</script>
</body>
</html>
